^^function appendconfig(config){
 if(!config.reflist) config.reflist = {};
	if (config.withSchema) {
		if(Object.keys(config.fields).length){
			for(var f in config.fields){
				$.append(config.fields[f], global.proto.schemas[config.withSchema].fields[f]);
			}
		}else{
			$.append(config.fields, global.proto.schemas[config.withSchema].fields);
		}
	}
  for(var f in config.fields){
	 if(config.fields[f].ref) config.reflist[config.fields[f].ref] = f;
	}
}$$

 ^^function bytype(f, model, fields){
  var type = f.type;
	^^if(type == "date"){$$
 			{{^^=model$$ | stddate}}
	^^}else if(type == "datetime"){$$
 			{{^^=model$$ | date:'yyyy/MM/dd HH:mm'}}
  ^^}else if(type == "image"){$$
<img ng-show="^^=model$$ != '' &amp;&amp; ^^=model$$ != undefined" class="img-thumbnail" ng-src="/^^=f.path$$/{{^^=model$$}}" ng-click="ui.openImageModal('/^^=f.path$$/'+^^=model$$)">
  ^^}else if(type == "video"){$$
<div ng-show="^^=model$$ == '' || ^^=model$$ == undefined" class="ng-hide">没有视频</div>
<video controls ng-show="^^=model$$ != '' &amp;&amp; ^^=model$$ != undefined" class="img-thumbnail" ng-src="{{'/^^=f.path$$/'+^^=model$$}}"></video>
<p><a class="btn btn-default" ng-href="/^^=f.path$$/{{^^=model$$}}">下载视频</a></p>
  ^^}else if(type == "file"){$$
<a class="btn btn-default" ng-href="/^^=f.path$$/{{^^=model$$}}">{{^^=model$$}}</a>
  ^^}else if(type == "ObjectId" && f.ref){$$
<div ng-show="!!^^=model$$">
<a class="btn btn-xs btn-default" ng-click="ui.openInfoModal('^^=f.ref$$', '^^=f.reffield || '_id'$$', ^^=model$$)">{{^^=model$$ | last:4}}</a>
	<a class="btn btn-xs btn-warning" ng-href="#/^^=f.ref$$_details/{{^^=model$$}}" target="_blank"><i class="fa fa-folder-open"></i></a>
</div>
  ^^}else if(f.ref){$$
<div ng-show="!!^^=model$$">
<a class="btn btn-xs btn-default" ng-click="ui.openInfoModal('^^=f.ref$$', '^^=f.reffield || '_id'$$', ^^=model$$)">{{^^=model$$}}</a>
</div>
  ^^}else{$$

    ^^if(f.ondemand && type == "ObjectId" && fields){$$
	<a ng-show="!!^^=model$$" class="btn btn-xs btn-default" ng-click="^^=fields$$.showrow^^=name$$=true" ng-hide="^^=fields$$.showrow^^=name$$">{{^^=model$$ | last:4}}</a>
	<div ng-click="^^=fields$$.showrow^^=name$$=false" ng-show="^^=fields$$.showrow^^=name$$">{{^^=model$$}}</div>
    ^^}else if(f.encrypt){$$
	<a class="btn btn-default btn-xs"><i class="fa fa-lock"></i></a>
    ^^}else if(f.href){$$
  <a ng-href="^^=f.href$${{row.^^=name$$}}">{{^^=model$$}}</a>
    ^^}else if(f.money){$$
			{{^^=model$$ | fmoney}}
    ^^}else if(f.enums && fields){$$
			{{^^=model$$ | fenums:^^=fields+'.'+f.name$$.enums}}
    ^^}else{$$
			{{^^=model$$}}
    ^^}$$
  ^^}$$
 ^^}$$

 ^^function newbytype(f, model, fields){
  var type = f.type;
	if(f.nomanual){
		bytype(f, model, fields);
    return;
  }$$
	^^if(type == "date"){$$
<input class="form-control" type="date" ng-model="^^=model$$"></input>
	^^}else if(type == "datetime"){$$
<input class="form-control" ng-model="^^=model$$"></input><pre>example: 2015/09/10 09:30</pre>
  ^^}else if(type == "image" || type=="video" || type=="file"){$$
<input type="file" class="form-control" file-model="^^=f.name$$.buffer">
<a class="btn btn-primary btn-xs" ng-click="access.saveUpload('^^=f.path$$', ^^=f.name$$, ^^=$.stem(model)$$, '^^=$.leaf(model)$$')">上传</a>
    ^^bytype(f, model, fields)$$
  ^^}else if(type == "float"){$$
<input class="form-control" ng-model="^^=model$$" ng-pattern="/^[0-9\.]+$/">
  ^^}else if(type == "int"){$$
    ^^if(f.enums && fields){$$
<select class="form-control" ng-model="^^=model$$" ng-init="^^=fields+'.'+f.name$$.enumsarr = ui.convert2arr(^^=fields+'.'+f.name$$.enums)" ng-options="item.key as item.val for item in ^^=fields+'.'+f.name$$.enumsarr"></select>
    ^^}else{$$
<input class="form-control" ng-model="^^=model$$" ng-pattern="/^[0-9]+$/">
    ^^}$$
  ^^}else if(type == "ObjectId" && f.ref){$$
	<input class="form-control" ng-model="^^=model$$">
  ^^}else{$$
    ^^if(f.encrypt){$$
	<input class="form-control" ng-model="^^=model$$" ng-show="showencrypt">
	<a class="btn btn-default btn-xs" ng-click="showencrypt = !showencrypt"><i class="fa fa-lock"></i></a>
    ^^}else{$$
	<input class="form-control" ng-model="^^=model$$">
    ^^}$$
  ^^}$$
 ^^}$$
 

^^function loadraw(addon){$$
 ^^
  if(!addon.text) addon.text = "";
  var attrstr = local.makeng(addon);
 $$
<^^=addon.tag$$ ^^=attrstr$$ >^^=addon.text$$</^^=addon.tag$$>
 
^^}$$
^^function makeitem(config, prefix, fieldsconfig){$$
  ^^for(var sname in config.fields){
   var f = config.fields[sname];
   if(f.hidden) continue;
   if(f.type == "func") continue;
  $$
	<div class="col-sm-^^=12/config.perline$$" uib-tooltip="^^=f.text || f.name$$">
		^^bytype(f, prefix+"."+f.name, fieldsconfig)$$
	</div>
  ^^}$$
^^}$$
^^local.makeng = function(sube){
	if(!sube) return "";
  var addonstr = "";
  if(sube.click)
  addonstr += 'ng-click="' + sube.click + '" ';
  if(sube.class)
  addonstr += 'ng-class="' + sube.class + '" ';
  if(sube.repeat)
  addonstr += 'ng-repeat="' + sube.repeat + '" ';
  if(sube.href)
  addonstr += 'ng-href="' + sube.href + '" ';
  if(sube.show)
  addonstr += 'ng-show="' + sube.show + '" ';
  if(sube.model)
	addonstr += 'ng-model="' + sube.model + '" ';
	if(sube.attr)
	addonstr += sube.attr + ' ';
	return addonstr;
}$$
^^local.makefunc = function(col, size){$$
	 ^^if(col.elements) for(var subname in col.elements){
     var sube = col.elements[subname];
     var addonstr = local.makeng(sube);  
   $$
    ^^if(sube.type == "button"){$$
  		<a class="btn btn-^^=size$$ btn-primary" ^^=addonstr$$>^^=sube.text || sube.name$$</a>
    ^^}else if(sube.type == "input"){$$
			<input class="form-control" placeholder="^^=sube.text || ''$$" ^^=addonstr$$>
    ^^}else{$$
			^^loadraw(sube)$$
    ^^}$$
   ^^}$$
^^}$$

^^local.panel = function(config){
if(!config.perline) config.perline = 3;
if(!config.width) config.width = 12;
var showstr="";
var hidestr="ng-hide=1";
if(config.show){
			showstr = "ng-show=\"" + config.show +"\"";
			hidestr = "ng-hide=\"" + config.show +"\"";
}
appendconfig(config);
$$
<div class="panel panel-primary">
<div class="panel-heading">^^=config.text || config.name$$</div>
<div class="panel-body" ^^=hidestr$$>
该项目未认证或未开通
</div>
<div class="panel-body" ^^=showstr$$>
	<div class="col-sm-^^=config.width$$">
		<div class="row">
 ^^if(!config.islist){
  makeitem(config, "schemas."+config.withSchema, "schemafields."+config.withSchema)
 }else{$$
 			<div class="row" ng-repeat="row in schemas.^^=config.withSchema$$">
  ^^makeitem(config, "row", "schemafields."+config.withSchema);$$
			</div>
 ^^}$$
		</div>
		<div class="row text-center" style="padding:10px">
  ^^for(var sname in config.fields){
   var f = config.fields[sname];
   if(f.hidden) continue;
   if(f.type != "func") continue;
  $$
	 ^^local.makefunc(f, 'md');$$
  ^^}$$	 
		</div>
	</div>
	<div class="col-sm-^^=12-config.width$$">
		^^for(var addname in config.addons){$$
		^^loadraw(config.addons[addname]);$$	
		^^}$$
	</div>
</div>
</div>
^^}$$

^^local.form = function(config){$$
^^if(config.tpl){$$
<script type="text/ng-template" id="^^=config.tpl$$">
^^}$$
<div class="row" style="padding:10px;">
<form role="form" style="padding:15px;max-width:400px;">
  <fieldset>
^^for(var fname in config.fields){
 var f=config.fields[fname];
 var ngstr = local.makeng(f);$$
 ^^if(f.type == "input"){$$
    <div class="form-group">
      <input style="min-width:100px" class="form-control" type="^^=f.inputtype || 'text'$$" ^^=ngstr$$ placeholder="^^=f.text || f.name$$">
    </div>
 ^^}else if(f.type == "button"){if(!f.style) f.style = "default";$$
    <button class="btn btn-md btn-^^=f.style$$" ^^=ngstr$$>^^=f.text$$</button>
 ^^}else{$$
		^^loadraw(f)$$
 ^^}$$
^^}$$
  </fieldset>
</form>
</div>
^^if(config.tpl){$$
</script>
^^}$$
^^}$$
^^local.makequery = function(config){$$
	<div class="row">
		<div class="col-sm-8">
			<div class="btn-group" role="group">
				<a class="btn btn-default" ng-click="^^=config.name$$.loadSave()">default</a>
				<a ng-repeat="save in ^^=config.name$$.savequerys" class="btn btn-default" ng-click="^^=config.name$$.loadSave(save)">{{save.name}}</a>
			</div>
		</div>
		<div class="col-sm-4 text-right">
			<div class="btn-group" role="group">
				<a class="btn btn-default" uib-tooltip="刷新" ng-click="^^=config.name$$.refresh()"><i class="fa fa-refresh"></i></a>
				<a class="btn btn-default" uib-tooltip="搜索" ng-click="showquery=!showquery"><i class="fa fa-search"></i></a>
				<a class="btn btn-default" uib-tooltip="统计（TODO）" ng-click="showstat=!showstat"><i class="fa fa-calculator"></i></a>
^^if(config.insert){$$
				<a class="btn btn-danger" uib-tooltip="添加" ng-click="^^=config.name$$.showadd()"><i class="fa fa-plus"></i></a>
^^}$$
			</div>
		</div>
		<div class="col-sm-6" ng-show="showsave" style="padding: 10px;border:1px;">
			<div class="form-group">
				<input class="form-control" placeholder="请为这次存储命名" ng-model="savename">
				<a class="form-control btn btn-default" ng-click="^^=config.name$$.save(savename)"></a>
			</div>
		</div>
		<div class="col-sm-6 borderbox" ng-show="showquery" style="padding: 10px;">
			<div class="btn-group" role="group">
		^^for(var key in config.reflist){$$
			<a class="btn btn-default" ng-click="^^=config.name$$.addRawQuery('^^=key$$')"><i class="fa fa-plus">^^=key$$</i></a>
    ^^}$$
			<a class="btn btn-default" ng-click="^^=config.name$$.addRawQuery()"><i class="fa fa-plus"></i></a>
			</div>
			<div class="btn-group" role="group">
			<a class="btn btn-default" ng-click="^^=config.name$$.rawquerys = []">Clear</a>
			<a class="btn btn-default" ng-click="^^=config.name$$.refresh()">Go</a>
			<a class="btn btn-default" ng-click="^^=config.name$$.saveQuery()"><i class="fa fa-save"></i></a>
			<input class="form-control" ng-model="^^=config.name$$.savename" placeholder="标识">
			</div>
			<form class="form-inline">
				<div class="form-group" style="padding:10px" ng-repeat="rawquery in ^^=config.name$$.rawquerys track by $index">
					<div class="input-group" ng-show="!rawquery.by">
						<select class="form-control" ng-model="rawquery.field" ng-options="key for key in ^^=config.name$$.fieldlist"></select>
						<select class="form-control" style="width:auto" ng-model="rawquery.op" ng-options="key for key in ^^=config.name$$.oplist"></select>
 ^^for(var fname in config.fields){
  var f=config.fields[fname];$$
						<div ng-show="rawquery.field == '^^=f.name$$'">
						^^newbytype(f, "rawquery.v"+f.name, config.name+".fields");$$
						</div>
 ^^}$$
					<a class="btn btn-default" ng-click="^^=config.name$$.rawquerys.splice($index, 1)"><i class="fa fa-minus"></i></a>
					</div>
					<div class="input-group" ng-show="!!rawquery.by">
						<div class="input-group-addon">{{rawquery.by}}</div>
						<select class="form-control" ng-model="rawquery.field" ng-options="key for key in ^^=config.name$$.refs[rawquery.by].fieldlist"></select>
						<select class="form-control" style="width:auto" ng-model="rawquery.op" ng-options="key for key in ^^=config.name$$.oplist"></select>
 ^^for(var key in config.reflist){var s=config.reflist[key];$$
  ^^for(var fname in global.proto.schemas[key].fields){var f=global.proto.schemas[key].fields[fname];$$
						<div ng-show="rawquery.field == '^^=f.name$$' && rawquery.by == '^^=key$$'">
						^^newbytype(f, "rawquery.v"+key+f.name, config.name+".refs."+key);$$
						</div>
  ^^}$$
 ^^}$$
					<a class="btn btn-default" ng-click="^^=config.name$$.rawquerys.splice($index, 1)"><i class="fa fa-minus"></i></a>
					</div>
				</div>
			</form>
		</div>
		<div class="col-sm-6 borderbox" ng-show="showstat">
			TODO
		</div>
	</div>
^^}$$
^^local.table = function(config){$$
^^appendconfig(config)$$
<div class="panel panel-primary">
<div class="panel-heading" ^^=local.makeng(config.heading)$$>^^=config.text || config.name$$</div>
<div class="panel-body" ^^=local.makeng(config.body)$$>
<div class="col-sm-9">
^^local.makequery(config)$$
</div>
<div class="col-sm-3">
	<div class="input-group">
  <input type="text" class="form-control" placeholder="page" ng-model="pageToGo">
  <span class="input-group-btn">
    <button class="btn btn-default" type="button" ng-click="^^=config.name$$.gotoPage(pageToGo)">Go!</button>
  </span>
	</div>
</div>
<div class="col-sm-6">
	<div class="form-inline" style="verical-align:middle;padding:0.2em 0;">
	<label style="font-weight:normal">Show <select class="form-control input-sm" ng-model="^^=config.name$$.perPage" ng-options="op for op in ^^=config.name$$.perPages"></select> entries</label>
	</div>
</div>
<div class="col-sm-6 text-right">
	^^pagenator(config)$$
</div>
  <div class="col-sm-12" style="overflow-x:auto;">
  <table class="table table-striped table-bordered" style="vertical-align:middle;">
		<thead>
 ^^var colnum = 0;
  for(var name in config.fields){
   var col = config.fields[name];
   if(col.hidden) continue;
   colnum++;
  $$
  ^^if(col.type == "func"){$$
  <th>^^=col.text || ""$$</th>
  ^^}else{$$
  <th><a style="padding: 0 5px;" ng-click="^^=config.name$$.changeSort('^^=name$$')"><i class="fa" ng-class="{'fa-sort-asc':^^=config.name$$.sort.^^=name$$ === 1,'fa-sort-desc': ^^=config.name$$.sort.^^=name$$ === -1,'fa-sort':!^^=config.name$$.sort.^^=name$$}"></i></a>^^=col.text||name$$<br/>^^=name$$</th>
  ^^}$$
 ^^}$$
 ^^if(config.update || config.delete){$$
  <th></th>
 ^^}$$
  </thead>
  <tbody>
		<tr style="background:#d9edf7;" ng-show="!^^=config.name$$.data"><td align="center" colspan="^^=colnum$$">加载中......</td></tr>
		<tr style="background:#d9edf7;" ng-show="^^=config.name$$.data &&  !^^=config.name$$.data.length"><td align="center" colspan="^^=colnum$$">没有数据</td></tr>
 ^^if(config.insert || config.update){$$
		<tr ng-show="^^=config.name$$.showinsertrow || ^^=config.name$$.showupdaterow" style="background: #f0ad4e;">
  ^^for(var name in config.fields){var col = config.fields[name];$$
   ^^if(col.hidden) continue;$$
 	<td>
   ^^if(col.type == 'func'){$$
	 ^^}else{$$
		^^newbytype(col, config.name+".new."+col.name, config.name+".fields");$$
	 ^^}$$
	</td>
  ^^}$$
	<td>
  	<a class="btn btn-sm btn-primary" ng-click="^^=config.name$$.upsert()">保存</a>
  	<a class="btn btn-sm btn-default" ng-click="^^=config.name$$.hiderow()">取消</a>
	</td>

		</tr>
 ^^}$$
    <tr ng-repeat="row in ^^=config.name$$.data">
 ^^for(var name in config.fields){var col = config.fields[name];$$
 ^^if(col.hidden) continue;$$
 	<td>
  ^^if(col.type == 'func'){$$
	 ^^local.makefunc(col, "xs");$$
  ^^}else{$$
		^^bytype(col, "row."+col.name, config.name+".fields")$$
 ^^}}$$

 ^^if(config.update || config.delete){$$
  <td>
		^^if(config.update){$$
  		<a class="btn btn-xs btn-danger" ng-click="^^=config.name$$.showupdate(row)">修改</a>
		^^}$$
		^^if(config.delete){$$
  		<a class="btn btn-xs btn-danger" ng-click="^^=config.name$$.showdelete(row._id)">删除</a>
		^^}$$
	</td>
 ^^}$$

		</tr>

	</tbody>
</table>
  </div>
<div class="col-sm-6"><div style="padding:0.5em 0;">Showing {{^^=config.name$$.perPage*(^^=config.name$$.currPage-1)+1}} to {{^^=config.name$$.perPage*^^=config.name$$.currPage}} of {{^^=config.name$$.count}} entries</div></div>
<div class="col-sm-6 text-right">
	^^pagenator(config)$$
</div>
</div>
</div>


 ^^function pagenator(config){$$
<ul class="pagination" style="margin:2px 0;">
  <li><a ng-click="^^=config.name$$.gotoFirst()" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
  <li ng-class="{active: p===^^=config.name$$.currPage}" ng-repeat="p in ^^=config.name$$.adj()"><a style="cursor:pointer;" ng-click="^^=config.name$$.gotoPage(p)">{{p}}</a></li>
  <li><a ng-click="^^=config.name$$.gotoLast()" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>
</ul>
 ^^}$$

^^}$$



